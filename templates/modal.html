{% load static %}

<!-- ‚öΩ CREATE / EDIT PRODUCT MODAL -->
<div id="crudModal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-blue-950 bg-opacity-80 transition-opacity duration-200">
  <div id="crudModalContent"
       class="bg-gradient-to-b from-blue-900 via-blue-800 to-blue-700 rounded-2xl shadow-2xl w-11/12 sm:w-3/5 md:w-1/2 lg:w-2/5 max-h-[90vh] overflow-y-auto border border-blue-600 transform scale-95 opacity-0 transition-all duration-200 ease-out relative">

    <!-- üîÑ Loading Overlay -->
    <div id="loadingOverlay"
         class="hidden absolute inset-0 flex flex-col items-center justify-center bg-blue-950 bg-opacity-70 rounded-2xl z-50">
      <div class="w-10 h-10 border-4 border-blue-400 border-t-transparent rounded-full animate-spin mb-3"></div>
      <p class="text-blue-200 text-sm font-medium">Processing...</p>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between p-5 border-b border-blue-600">
      <div>
        <h3 id="crudModalTitle" class="text-2xl font-bold text-white">Add New Product</h3>
        <p id="crudModalSubtitle" class="text-sm text-blue-200 mt-1">List your football item in the shop catalog</p>
      </div>
      <button type="button"
              class="text-blue-300 hover:text-white bg-transparent hover:bg-blue-800 rounded-lg p-2 transition-colors"
              onclick="hideModal()">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
             stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Body -->
    <div class="px-6 py-5 text-white">
      <form id="productForm" class="space-y-5">
        <input type="hidden" id="product_id" name="product_id">

        <!-- Product Name -->
        <div>
          <label for="name" class="block text-sm font-medium text-blue-200">Product Name</label>
          <input type="text" id="name" name="name"
                 class="mt-1 block w-full rounded-md bg-blue-800 border border-blue-600 px-3 py-2 text-white placeholder-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none"
                 placeholder="Enter product name" required>
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-medium text-blue-200">Description</label>
          <textarea id="description" name="description" rows="3"
                    class="mt-1 block w-full rounded-md bg-blue-800 border border-blue-600 px-3 py-2 text-white placeholder-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none"
                    placeholder="Describe your product" required></textarea>
        </div>

        <!-- Brand -->
        <div>
          <label for="brand" class="block text-sm font-medium text-blue-200">Brand</label>
          <input type="text" id="brand" name="brand"
                 class="mt-1 block w-full rounded-md bg-blue-800 border border-blue-600 px-3 py-2 text-white placeholder-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none"
                 placeholder="Nike, Adidas, Puma...">
        </div>

        <!-- Price -->
        <div>
          <label for="price" class="block text-sm font-medium text-blue-200">Price (Rp)</label>
          <input type="number" id="price" name="price" min="0" step="1000"
                 class="mt-1 block w-full rounded-md bg-blue-800 border border-blue-600 px-3 py-2 text-white placeholder-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none"
                 placeholder="Enter product price" required>
        </div>

        <!-- Category -->
        <div>
          <label for="category" class="block text-sm font-medium text-blue-200">Category</label>
          <select id="category" name="category"
                  class="mt-1 block w-full rounded-md bg-blue-800 border border-blue-600 px-3 py-2 text-white focus:ring-2 focus:ring-blue-400 focus:outline-none"
                  required>
            <option value="">Select category</option>
            <option value="jersey">Jersey</option>
            <option value="boots">Football Boots</option>
            <option value="accessories">Accessories</option>
            <option value="training">Training Gear</option>
            <option value="other">Other</option>
          </select>
        </div>

        <!-- Thumbnail -->
        <div>
          <label for="thumbnail" class="block text-sm font-medium text-blue-200">Thumbnail URL</label>
          <input type="url" id="thumbnail" name="thumbnail"
                 class="mt-1 block w-full rounded-md bg-blue-800 border border-blue-600 px-3 py-2 text-white placeholder-blue-400 focus:ring-2 focus:ring-blue-400 focus:outline-none"
                 placeholder="https://example.com/image.jpg">
        </div>

        <!-- Featured -->
        <div class="flex items-center">
          <input id="is_featured" name="is_featured" type="checkbox"
                 class="w-4 h-4 text-blue-500 bg-blue-800 border-blue-600 rounded focus:ring-blue-400">
          <label for="is_featured" class="ml-2 text-sm font-medium text-blue-200">Mark as Featured Product</label>
        </div>
      </form>
    </div>

    <!-- Footer -->
    <div class="flex flex-col sm:flex-row gap-3 p-6 border-t border-blue-600 bg-blue-900 rounded-b-lg">
      <button type="button"
              class="order-2 sm:order-1 px-6 py-3 border border-blue-600 text-blue-200 rounded-md font-medium hover:bg-blue-800 hover:text-white transition-colors"
              onclick="hideModal()">Cancel</button>
      <button type="submit" form="productForm" id="modalSubmitButton"
              class="order-1 sm:order-2 flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-semibold transition-all">Add Product</button>
    </div>
  </div>
</div>

<!-- üóëÔ∏è DELETE CONFIRMATION MODAL (unchanged) -->
<div id="deleteModal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-blue-950 bg-opacity-80 transition-opacity duration-200">
  <div id="deleteModalContent"
       class="bg-gradient-to-b from-blue-900 via-blue-800 to-blue-700 rounded-2xl shadow-2xl w-11/12 sm:w-96 border border-blue-600 transform scale-95 opacity-0 transition-all duration-200 ease-out">

    <div class="flex items-center justify-between p-5 border-b border-blue-600">
      <h3 class="text-2xl font-bold text-white">Delete Product</h3>
      <button type="button"
              class="text-blue-300 hover:text-white bg-transparent hover:bg-blue-800 rounded-lg p-2 transition-colors"
              onclick="hideDeleteModal()">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
             stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="px-6 py-6 text-center text-blue-100">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-14 h-14 mx-auto mb-4 text-red-400" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <p class="text-lg font-medium">Are you sure you want to delete this product?</p>
      <p class="text-sm text-blue-300 mt-2">This action cannot be undone.</p>
    </div>

    <div class="flex justify-end space-x-3 p-5 border-t border-blue-600 bg-blue-900 rounded-b-lg">
      <button type="button"
              class="px-5 py-2 border border-blue-600 text-blue-200 rounded-md font-medium hover:bg-blue-800 hover:text-white transition"
              onclick="hideDeleteModal()">Cancel</button>
      <button id="confirmDeleteBtn"
              class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md font-semibold transition">
        Delete
      </button>
    </div>
  </div>
</div>

<!-- üåê SCRIPTS -->
<script>
  let isEditing = false;
  let productToDeleteId = null;

  function getCSRFToken() {
    const cookieValue = document.cookie
      .split("; ")
      .find(r => r.startsWith("csrftoken="))
      ?.split("=")[1];
    return cookieValue || document.querySelector("[name=csrfmiddlewaretoken]")?.value;
  }

  function showToast(title, message = '', type = 'info') {
    let container = document.getElementById("toast-container");
    if (!container) {
      container = document.createElement("div");
      container.id = "toast-container";
      container.className = "fixed top-5 right-5 space-y-3 z-[9999]";
      document.body.appendChild(container);
    }
    const toast = document.createElement("div");
    toast.className = `px-4 py-3 rounded-lg shadow-lg border text-sm animate-fadeIn
                       ${type === "success"
                          ? "bg-green-900/50 border-green-700 text-green-300"
                          : type === "error"
                          ? "bg-red-900/50 border-red-700 text-red-300"
                          : "bg-gray-700 border-gray-600 text-gray-200"}`;
    toast.innerHTML = `<strong class="block mb-1">${title}</strong>${message}`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  }

  /* ---------- CREATE / EDIT ---------- */
  function showModal(product = null) {
    const modal = document.getElementById('crudModal');
    const modalContent = document.getElementById('crudModalContent');
    const title = document.getElementById('crudModalTitle');
    const subtitle = document.getElementById('crudModalSubtitle');
    const submitButton = document.getElementById('modalSubmitButton');
    const form = document.getElementById('productForm');

    modal.classList.remove('hidden');
    setTimeout(() => {
      modalContent.classList.remove('opacity-0', 'scale-95');
      modalContent.classList.add('opacity-100', 'scale-100');
    }, 50);

    if (product) {
      isEditing = true;
      title.textContent = "Edit Product";
      subtitle.textContent = "Update your product information";
      submitButton.textContent = "Update Product";
      document.getElementById('product_id').value = product.id;
      document.getElementById('name').value = product.name;
      document.getElementById('description').value = product.description;
      document.getElementById('brand').value = product.brand || '';
      document.getElementById('price').value = product.price;
      document.getElementById('category').value = product.category;
      document.getElementById('thumbnail').value = product.thumbnail || '';
      document.getElementById('is_featured').checked = !!product.is_featured;
    } else {
      isEditing = false;
      title.textContent = "Add New Product";
      subtitle.textContent = "List your football item in the shop catalog";
      submitButton.textContent = "Add Product";
      form.reset();
      document.getElementById('product_id').value = '';
    }
  }

  function hideModal() {
    const modal = document.getElementById('crudModal');
    const modalContent = document.getElementById('crudModalContent');
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');
    setTimeout(() => modal.classList.add('hidden'), 150);
  }

  async function handleProductSubmit() {
    const form = document.getElementById('productForm');
    const overlay = document.getElementById('loadingOverlay');
    const id = document.getElementById('product_id').value;
    const url = isEditing
      ? `/product/${id}/edit-product/`
      : "{% url 'main:add_product_ajax' %}";
    const csrfToken = getCSRFToken();

    overlay.classList.remove('hidden'); // Show loading

    try {
      const response = await fetch(url, {
        method: "POST",
        body: new FormData(form),
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": csrfToken
        },
        credentials: "same-origin"
      });

      let data = {};
      try { data = await response.json(); } catch {}

      if (response.ok && (data.success || Object.keys(data).length === 0)) {
        hideModal();
        showToast(
          isEditing ? "‚úÖ Product updated successfully!" : "‚úÖ Product added successfully!",
          isEditing ? "Your changes have been saved." : "Your new football item is now listed.",
          "success"
        );
        document.dispatchEvent(new CustomEvent("productAdded"));
      } else {
        showToast("‚ùå Failed to save product", data.error || "Please check your fields.", "error");
      }
    } catch {
      showToast("‚ö†Ô∏è Error", "Something went wrong. Try again.", "error");
    } finally {
      overlay.classList.add('hidden'); // Hide loading
    }
  }

  document.getElementById('productForm').addEventListener('submit', e => {
    e.preventDefault();
    handleProductSubmit();
  });

  /* ---------- DELETE (UNCHANGED) ---------- */
  function showDeleteModal(productId) {
    productToDeleteId = productId;
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    modal.classList.remove('hidden');
    setTimeout(() => {
      modalContent.classList.remove('opacity-0', 'scale-95');
      modalContent.classList.add('opacity-100', 'scale-100');
    }, 50);
  }

  function hideDeleteModal() {
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');
    setTimeout(() => modal.classList.add('hidden'), 150);
  }

  document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
    if (!productToDeleteId) return;
    const csrfToken = getCSRFToken();
    try {
      const response = await fetch(`/product/${productToDeleteId}/delete-product/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
        credentials: "same-origin"
      });
      if (!response.ok) {
        showToast("‚ùå Error", "Failed to delete product.", "error");
        return;
      }
      hideDeleteModal();
      showToast("üóëÔ∏è Product deleted successfully!", "", "success");
      document.dispatchEvent(new CustomEvent("productAdded"));
    } catch {
      showToast("‚ö†Ô∏è Error", "Something went wrong while deleting.", "error");
    }
  });
</script>

<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
</style>




