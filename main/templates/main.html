{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>⚽ Soccers Apparel - Shop</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
{% include 'modal.html' %}

<div class="bg-gradient-to-b from-blue-950 via-blue-900 to-blue-800 w-full pt-20 min-h-screen text-white relative overflow-hidden">

  <!-- Glowing background -->
  <div class="absolute w-72 h-72 bg-blue-600/20 rounded-full blur-3xl top-20 left-10 animate-pulse"></div>
  <div class="absolute w-96 h-96 bg-blue-400/10 rounded-full blur-3xl bottom-10 right-10 animate-pulse"></div>

  <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <!-- Header -->
    <div class="mb-12 text-center animate-fade-in-down">
      <h1 class="text-4xl font-extrabold text-white mb-3 drop-shadow-lg">
        ⚽ Welcome to <span class="text-blue-300">Soccers Apparel</span> ⚽
      </h1>
      <p class="text-blue-200 text-lg">Find the best football gear and apparel for your game</p>
    </div>

    <!-- Create Button -->
    <button onclick="showModal()" 
      class="inline-flex items-center px-4 py-2 bg-blue-700 text-white font-semibold 
          border border-blue-500 rounded-md 
          hover:bg-blue-600 hover:border-blue-400 
          hover:shadow-md transition-all duration-200 
          mb-4">
      + Create Product using AJAX
    </button>

    <!-- Filter -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-12 bg-blue-800/70 rounded-xl border border-blue-600 p-5 shadow-lg backdrop-blur-sm animate-fade-in-up">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <button id="filter-my"
          class="bg-white text-blue-800 border border-blue-300 px-5 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105 hover:bg-blue-700 hover:text-white shadow-md">
          My Products
        </button>
        <button id="filter-all"
          class="bg-blue-600 text-white px-5 py-2 rounded-lg font-medium transition-all duration-300 hover:scale-105 hover:bg-blue-700 hover:text-white shadow-md">
          All Products
        </button>
        <button id="reload-products"
          class="bg-blue-700 text-white px-4 py-2 rounded-md hover:bg-blue-800 transition flex items-center gap-2">
          <span id="reload-icon">🔄</span>
          <span id="reload-text" class="hidden sm:inline">Refresh</span>
        </button>
      </div>
      {% if user.is_authenticated %}
      <div class="text-sm text-blue-200 italic">
        Last login: <span class="font-semibold">{{ last_login }}</span>
      </div>
      {% endif %}
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden bg-blue-900/70 rounded-xl border border-blue-700 p-12 text-center shadow-lg animate-fade-in-up">
      <div class="flex flex-col items-center justify-center">
        <svg class="animate-spin h-10 w-10 text-blue-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <p class="text-blue-300 text-lg font-medium animate-pulse">Loading products, please wait...</p>
      </div>
    </div>

    <!-- Error -->
    <div id="error" class="hidden bg-red-900/60 rounded-xl border border-red-700 p-10 text-center shadow-lg animate-fade-in-up">
      <svg class="w-12 h-12 mx-auto text-red-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4m0 4h.01M21 12A9 9 0 113 12a9 9 0 0118 0z"/>
      </svg>
      <h3 class="text-xl font-semibold text-white mb-2">Failed to Load Products</h3>
      <p class="text-blue-200 mb-4">Something went wrong while fetching the data.</p>
      <button id="retryButton" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-semibold transition">
        Retry
      </button>
    </div>

    <!-- Product Grid -->
    <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 animate-fade-in-up hidden transition-opacity duration-500 opacity-100"></div>

    <!-- Empty -->
    <div id="empty" class="hidden bg-blue-900/70 rounded-xl border border-blue-700 p-12 text-center shadow-lg animate-fade-in-up">
      <div class="w-32 h-32 mx-auto mb-6">
        <img src="https://jalongi.com/public/assets/images/product_not_found.jpeg" alt="No products available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-2xl font-bold text-white mb-3">No Products Found</h3>
      <p class="text-blue-300 mb-6">Be the first to add your football product!</p>
      <button onclick="showModal()" 
        class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 hover:scale-105 transition-all shadow-md">
        + Add Product
      </button>
    </div>

  </div>
</div>

<!-- ✅ AJAX Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const grid = document.getElementById("grid");
  const loading = document.getElementById("loading");
  const empty = document.getElementById("empty");
  const errorBox = document.getElementById("error");
  const retryButton = document.getElementById("retryButton");

  const btnAll = document.getElementById("filter-all");
  const btnMy = document.getElementById("filter-my");
  const reloadBtn = document.getElementById("reload-products");
  const reloadIcon = document.getElementById("reload-icon");

  const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
  const PRODUCTS_API = "{% url 'main:show_json' %}";

  let activeFilter = localStorage.getItem("activeFilter") || "all";
  let allProducts = [];

  /* 🌈 Toast Notification */
  function showToast(title, message, type = "success") {
    const toast = document.createElement("div");
    toast.className = `
      fixed bottom-6 right-6 px-5 py-4 rounded-lg shadow-lg text-white 
      toast-fade z-50
      ${type === "error" ? "bg-red-600" : "bg-green-600"}
    `;
    toast.innerHTML = `<strong class="block text-sm">${title}</strong>
                       <p class="text-sm">${message}</p>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  /* 🔘 Update Filter Buttons */
  function updateFilterButtons() {
    btnAll.className =
      activeFilter === "all"
        ? "bg-blue-600 text-white px-5 py-2 rounded-md font-medium hover:bg-blue-700 transition"
        : "bg-white text-blue-800 border border-blue-300 px-5 py-2 rounded-md font-medium hover:bg-blue-600 hover:text-white transition";
    btnMy.className =
      activeFilter === "my"
        ? "bg-blue-600 text-white px-5 py-2 rounded-md font-medium hover:bg-blue-700 transition"
        : "bg-white text-blue-800 border border-blue-300 px-5 py-2 rounded-md font-medium hover:bg-blue-600 hover:text-white transition";
  }

  /* 🦴 Skeleton Placeholder */
  function showSkeletons() {
    grid.innerHTML = "";
    grid.classList.remove("hidden");
    for (let i = 0; i < 6; i++) {
      grid.innerHTML += `<div class="animate-pulse bg-blue-800/40 rounded-xl h-64 w-full shadow-inner"></div>`;
    }
  }

  /* 🧩 Product Card Builder */
  function buildProductCardElement(product) {
    const article = document.createElement("article");
    article.className =
      "rounded-lg border border-blue-700 bg-gradient-to-br from-blue-200 via-blue-400 to-blue-800 hover:shadow-xl transition-shadow duration-300 overflow-hidden flex flex-col h-full";

    const linkDetail = `/product/${product.id}/`;
    const name = DOMPurify.sanitize(product.name);
    const description = DOMPurify.sanitize(product.description);
    const category = DOMPurify.sanitize(product.category || "Uncategorized");
    const thumbnail = DOMPurify.sanitize(product.thumbnail || "https://jalongi.com/public/assets/images/product_not_found.jpeg");
    const price = DOMPurify.sanitize(`Rp ${Number(product.price || 0).toLocaleString("id-ID")}`);
    const brand = DOMPurify.sanitize(product.brand || "Unknown");
    const createdAt = DOMPurify.sanitize(
      new Date(product.created_at).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })
    );

    const isFeatured = product.is_featured;
    const isOwner = "{{ user.id }}" && Number("{{ user.id }}") === Number(product.user_id);
    const featuredBadge = isFeatured
      ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Featured</span>`
      : "";

    const editDeleteHtml = isOwner
      ? `<div class='flex space-x-3'>
          <button onclick='showModal(${JSON.stringify(product)})' class='text-yellow-300 hover:text-yellow-400 text-sm transition-colors'>Edit</button>
          <button onclick='showDeleteModal(${product.id})' class='text-red-400 hover:text-red-500 text-sm transition-colors'>Delete</button>
        </div>`
      : "";

    article.innerHTML = `
      <div class="aspect-[16/9] relative overflow-hidden">
        <img src="${thumbnail}" alt="${name}" class="w-full h-64 object-cover">
        <div class="absolute top-3 left-3">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-900 text-white shadow">${category}</span>
        </div>
        <div class="absolute top-3 right-3 flex space-x-2">${featuredBadge}</div>
      </div>
      <div class="p-5 flex flex-col flex-1 text-white">
        <div class="flex items-center text-sm text-blue-200 mb-3">
          <time>${createdAt}</time>
          <span class="mx-2">•</span>
          <span>${brand}</span>
        </div>
        <h3 class="text-lg font-semibold mb-2 leading-tight">
          <a href="${linkDetail}" class="hover:text-yellow-300 transition-colors">${name}</a>
        </h3>
        <p class="text-sm opacity-90 leading-relaxed mb-3">${description}</p>
        <p class="text-md font-bold text-yellow-300 mb-4">${price}</p>
        <div class="pt-4 border-t border-blue-700 flex items-center justify-between">
          <a href="${linkDetail}" class="text-yellow-300 hover:text-yellow-400 font-medium text-sm transition-colors">View details</a>
          ${editDeleteHtml}
        </div>
      </div>
    `;
    return article;
  }

  /* ✨ Render Products + Empty State */
  function renderProducts(products) {
    grid.innerHTML = "";
    grid.classList.remove("hidden");

    if (products.length === 0) {
      grid.classList.add("hidden");
      empty.classList.remove("hidden");
      showToast("📭 Empty", "No products found.", "info");
      return;
    }

    empty.classList.add("hidden");
    products.forEach((p) => grid.appendChild(buildProductCardElement(p)));
  }

  /* 🎯 Filter + Display Products */
  function filterAndDisplayProducts() {
    updateFilterButtons();

    const filtered =
      activeFilter === "my"
        ? allProducts.filter((p) => String(p.user_id) === String(CURRENT_USER_ID))
        : allProducts;

    renderProducts(filtered);
  }

  /* 🌐 Fetch Products with Error State */
  async function fetchProductsFromServer(showToastOnLoad = true) {
    try {
      // Reset states
      empty.classList.add("hidden");
      errorBox.classList.add("hidden");
      grid.classList.add("opacity-0");
      loading.classList.remove("hidden");
      showSkeletons();

      // Simulate request delay + Fetch
      const response = await fetch(PRODUCTS_API, { headers: { Accept: "application/json" } });
      if (!response.ok) throw new Error("Failed to fetch products");

      const data = await response.json();
      allProducts = data;

      setTimeout(() => {
        filterAndDisplayProducts();
        loading.classList.add("hidden");
        grid.classList.remove("opacity-0");
        grid.classList.add("opacity-100");

        if (showToastOnLoad) {
          setTimeout(() => showToast("✅ Loaded", "Products loaded successfully!", "success"), 400);
        }
      }, 800);
    } catch (error) {
      // 🚨 Show Error State
      loading.classList.add("hidden");
      grid.classList.add("hidden");
      empty.classList.add("hidden");
      errorBox.classList.remove("hidden");
      showToast("❌ Error", "Failed to load products. Please try again.", "error");
      console.error("Product fetch failed:", error);
    }
  }

  /* 🔁 Retry Button */
  retryButton.addEventListener("click", async () => {
    showToast("🔄 Retrying...", "Attempting to reload products...", "info");
    errorBox.classList.add("hidden");
    await fetchProductsFromServer();
  });

  /* 🧭 Filter Buttons */
  btnAll.addEventListener("click", () => {
    activeFilter = "all";
    localStorage.setItem("activeFilter", "all");
    filterAndDisplayProducts();
  });

  btnMy.addEventListener("click", () => {
    activeFilter = "my";
    localStorage.setItem("activeFilter", "my");
    filterAndDisplayProducts();
  });

  /* 🔃 Reload Button */
  reloadBtn.addEventListener("click", async () => {
    reloadBtn.disabled = true;
    reloadIcon.textContent = "";
    await fetchProductsFromServer(true);
    setTimeout(() => {
      reloadIcon.textContent = "🔄";
      reloadBtn.disabled = false;
    }, 1200);
  });

  /* 🚀 Initial Load */
  fetchProductsFromServer();

  /* 🎯 Reload when product added or edited */
  document.addEventListener("productAdded", () => fetchProductsFromServer(false));
});
</script>

<style>
.opacity-0 { opacity: 0; }
.opacity-100 { opacity: 1; }
.transition-opacity { transition: opacity 0.4s ease-in-out; }

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.toast-fade {
  animation: fadeInUp 0.4s ease-in-out;
}
</style>

{% endblock content %}











